global
{#-    log 127.0.0.1   local0#}
{#-    log 127.0.0.1   local1 notice#}
    maxconn             4096
{#-    user                haproxy#}
{#-    group               haproxy#}
{#-    #daemon#}

defaults
    log                 global
    mode                http
    option              httplog
    option              dontlognull
    option              forwardfor
    option              http-server-close
    timeout connect     5000ms
    timeout client      50000ms
    timeout server      50000ms

{%- if haproxy.stats_enable %}
    {#- TODO: more generic setup #}
    stats               enable
    stats               auth {{ haproxy.stats_user }}:{{ haproxy.stats_password }}
    stats               uri /stats
{%- endif %}

frontend http
    bind *:80
{%- for service in services %}
    {% set name=service.ServiceName | replace('-', '_') %}
    # AUTO: {{ service.ServiceName }} frontend
    acl host_{{ name }} hdr(host) -i {{ service.Domain | default(None) or (service.ServiceName + '.service.consul') }}
    use_backend backend_{{ name }} if host_{{ name }}
{%- endfor %}
{%- for service in services %}
    {% set name=service.ServiceName | replace('-', '_') %}
# AUTO: {{ service.ServiceName }} backend
backend backend_{{ name }}
    balance leastconn
    option httpclose
    option forwardfor
    server {{ service.Node }} {{ service.ServiceAddress }}:{{ service.Port | default(service.ServicePort) }} cookie A check
{% endfor %}