global
{#-    log 127.0.0.1   local0#}
{#-    log 127.0.0.1   local1 notice#}
    maxconn             4096
{#-    user                haproxy#}
{#-    group               haproxy#}
{#-    #daemon#}

defaults
    log     global
    mode    http
    timeout connect 5000
    timeout client 50000
    timeout server 50000

{#{%- if haproxy.stats_enable %}#}
    {#- TODO: more generic setup #}
{#    stats               enable#}
{#    stats               auth test:test#}
{#    stats               uri /stats#}
{#{%- endif %}#}

frontend http
    bind 0.0.0.0:80
{%- for service in services %}
    {% set name=service.ServiceName | replace('-', '_') %}
    # AUTO: {{ service.ServiceName }} frontend
    acl host_{{ name }} hdr(host) -i {{ service.Domain | default(None) or (service.ServiceName + '.service.consul') }}
    use_backend backend_{{ name }} if host_{{ name }}
{%- endfor %}
{%- for service in services %}
    {% set name=service.ServiceName | replace('-', '_') %}
# AUTO: {{ service.ServiceName }} backend
backend backend_{{ name }}
    server {{ service.Node }} {{ service.ServiceAddress }}:{{ service.Port | default(service.ServicePort) }} cookie A check
{% endfor %}